<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temu Coupons Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@heroicons/v1/outline"></script>
</head>

<body class="min-h-screen bg-[#0d1117] text-[#c9d1d9]">
    <div class="container mx-auto px-4 py-8 space-y-8">
        <div class="max-w-7xl mx-auto bg-[#161b22] rounded-2xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Temu Coupons Dashboard</h1>
                <div class="flex space-x-4">
                    <a href="/"
                        class="px-6 py-3 bg-[#30363d] text-[#c9d1d9] rounded-xl hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 hover:bg-[#484f58] focus:outline-none focus:ring-2 focus:ring-[#30363d] focus:ring-offset-2">
                        Back to Dashboard
                    </a>
                    <a href="/screen/coupon"
                        class="px-6 py-3 bg-[#238636] text-[#c9d1d9] rounded-xl hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 hover:bg-[#2ea043] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:ring-offset-2">
                        Create New Coupon
                    </a>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div
                    class="bg-[#161b22] rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300 border border-[#30363d]">
                    <h3 class="text-lg font-semibold mb-2 text-[#c9d1d9]">Total Coupons</h3>
                    <p class="text-3xl font-bold text-[#c9d1d9]">
                        <%= totalCoupons %>
                    </p>
                </div>
                <div
                    class="bg-[#161b22] rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300 border border-[#30363d]">
                    <h3 class="text-lg font-semibold mb-2 text-[#c9d1d9]">Active Coupons</h3>
                    <p class="text-3xl font-bold text-[#58a6ff]">
                        <%= activeCoupons %>
                    </p>
                </div>
                <div
                    class="bg-[#161b22] rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300 border border-[#30363d]">
                    <h3 class="text-lg font-semibold mb-2 text-[#c9d1d9]">Expired Coupons</h3>
                    <p class="text-3xl font-bold text-[#f85149]">
                        <%= expiredCoupons %>
                    </p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="mb-6 flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search coupons by title or code..."
                        class="w-full px-4 py-3 bg-[#0d1117] border border-[#30363d] rounded-xl text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:border-transparent placeholder-[#8b949e]">
                </div>
                <div class="flex gap-3 relative">
                    <div class="relative">
                        <select id="categoryFilter"
                            class="px-4 py-3 appearance-none bg-[#0d1117] border border-[#30363d] rounded-xl text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:border-transparent hover:border-[#58a6ff] transition-colors duration-200 min-w-[160px]">
                            <option value="">All Categories</option>
                            <option value="electronics">Electronics</option>
                            <option value="fashion">Fashion</option>
                            <option value="home">Home</option>
                            <option value="garden">Garden</option>
                            <option value="beauty">Beauty</option>
                            <option value="health">Health</option>
                            <option value="sports">Sports</option>
                            <option value="toys">Toys</option>
                            <option value="automotive">Automotive</option>
                            <option value="books">Books</option>
                            <option value="food">Food</option>
                            <option value="other">Other</option>
                        </select>
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[#c9d1d9] pointer-events-none"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="relative">
                        <select id="typeFilter"
                            class="px-4 py-3 appearance-none bg-[#0d1117] border border-[#30363d] rounded-xl text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:border-transparent hover:border-[#58a6ff] transition-colors duration-200 min-w-[150px]">
                            <option value="">All Types</option>
                            <option value="expiry-soon">‚è∞ Expiry Soon</option>
                            <option value="most-popular">üî• Most Popular</option>
                            <option value="almost-gone">‚ö° Almost Gone</option>
                        </select>
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[#c9d1d9] pointer-events-none"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="relative">
                        <select id="statusFilter"
                            class="px-4 py-3 appearance-none bg-[#0d1117] border border-[#30363d] rounded-xl text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:border-transparent hover:border-[#58a6ff] transition-colors duration-200 min-w-[140px]">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="expired">Expired</option>
                        </select><svg
                            class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[#c9d1d9] pointer-events-none"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Coupons Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-center">
                    <thead class="bg-[#0d1117] border-b border-[#30363d]">
                        <tr>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Title</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Code</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Category</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Type</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Discount</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Quantity</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Expiration</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Status</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="couponsTableBody">
                        <% if (coupons && coupons.length> 0) { %>
                            <% coupons.forEach(coupon=> { %>
                                <tr class="border-b border-[#30363d] hover:bg-[#1f2937] transition-colors duration-200">
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-[#c9d1d9]">
                                            <%= coupon.title %>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-mono text-sm text-[#58a6ff] bg-[#1f2937] px-2 py-1 rounded">
                                            <%= coupon.couponCode || 'N/A' %>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#1f2937] text-[#c9d1d9]">
                                            <%= coupon.category.charAt(0).toUpperCase() + coupon.category.slice(1) %>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <% const couponType=coupon.type; let typeClass='bg-[#6b7280] text-white' ; let
                                            typeDisplay='' ; if (couponType==='expiry-soon' ) {
                                            typeClass='bg-[#d1a627] text-[#1c1917]' ; typeDisplay='‚è∞ Expiry Soon' ; }
                                            else if (couponType==='most-popular' ) { typeClass='bg-[#2ea043] text-white'
                                            ; typeDisplay='üî• Most Popular' ; } else if (couponType==='almost-gone' ) {
                                            typeClass='bg-[#f85149] text-white' ; typeDisplay='‚ö° Almost Gone' ; } %>
                                            <div
                                                class="font-mono text-sm text-[#58a6ff] bg-[#1f2937] px-2 py-1 rounded">
                                                <%= typeDisplay %>
                                            </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="text-lg font-semibold text-[#f85149]">
                                            -<%= coupon.discount %>%
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center">
                                            <span class="text-[#c9d1d9]">
                                                <%= coupon.usedQuantity %> / <%= coupon.totalQuantity %>
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="text-[#8b949e]">
                                            <% let expirationDate; if (coupon.expirationDate &&
                                                coupon.expirationDate.toDate) { // Handle Firestore timestamp
                                                expirationDate=coupon.expirationDate.toDate(); } else if
                                                (coupon.expirationDate) { // Handle regular date string
                                                expirationDate=new Date(coupon.expirationDate); } else {
                                                expirationDate=new Date(); } if (isNaN(expirationDate.getTime())) { %>
                                                Invalid Date
                                                <% } else { %>
                                                    <%= expirationDate.getDate() %>
                                                        <%= expirationDate.toLocaleDateString('en-US', { month: 'short'
                                                            }) %>
                                                            <%= expirationDate.getFullYear() %>
                                                                <% } %>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <% let isExpired=false; let isActive=false; if (coupon.expirationDate &&
                                            coupon.expirationDate.toDate) { // Handle Firestore timestamp const
                                            expDate=coupon.expirationDate.toDate(); isExpired=expDate <=new Date() ||
                                            coupon.usedQuantity>= coupon.totalQuantity;
                                            isActive = !isExpired;
                                            } else if (coupon.expirationDate) {
                                            // Handle regular date string
                                            const expDate = new Date(coupon.expirationDate);
                                            if (!isNaN(expDate.getTime())) {
                                            isExpired = expDate <= new Date() || coupon.usedQuantity>=
                                                coupon.totalQuantity;
                                                isActive = !isExpired;
                                                } else {
                                                isExpired = true;
                                                isActive = false;
                                                }
                                                } else {
                                                isExpired = true;
                                                isActive = false;
                                                }

                                                if (isActive) { %>
                                                <span
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#238636] text-white">
                                                    Active
                                                </span>
                                                <% } else { %>
                                                    <span
                                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#f85149] text-white">
                                                        Expired
                                                    </span>
                                                    <% } %>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="relative">
                                            <button onclick="toggleDropdown('<%= coupon.id %>')"
                                                class="p-2 hover:bg-[#30363d] rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#238636]">
                                                <svg class="w-5 h-5 text-[#c9d1d9]" fill="currentColor"
                                                    viewBox="0 0 20 20">
                                                    <path
                                                        d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                                                </svg>
                                            </button>
                                            <div id="dropdown-<%= coupon.id %>"
                                                class="absolute right-0 top-8 mt-2 w-48 bg-[#161b22] border border-[#30363d] rounded-lg shadow-lg z-10 hidden">
                                                <div class="py-1">
                                                    <a href="/screen/coupon?id=<%= coupon.id %>"
                                                        class="flex items-center px-4 py-2 text-sm text-[#c9d1d9] hover:bg-[#30363d] transition-colors">
                                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                                        </svg>
                                                        Edit Coupon
                                                    </a>
                                                    <button onclick="deleteCoupon('<%= coupon.id %>')"
                                                        class="flex items-center w-full px-4 py-2 text-sm text-[#f85149] hover:bg-[#30363d] transition-colors">
                                                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                        </svg>
                                                        Delete Coupon
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="9" class="px-6 py-8 text-center text-[#8b949e]">
                                                <div class="text-lg">No coupons found</div>
                                                <div class="text-sm mt-2">Create your first coupon to get started</div>
                                            </td>
                                        </tr>
                                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            filterCoupons();
        });

        // Filter functionality
        document.getElementById('categoryFilter').addEventListener('change', filterCoupons);
        document.getElementById('typeFilter').addEventListener('change', filterCoupons);
        document.getElementById('statusFilter').addEventListener('change', filterCoupons);

        function filterCoupons() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase().trim();
            const typeFilter = document.getElementById('typeFilter').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase().trim();

            const rows = document.querySelectorAll('#couponsTableBody tr');

            rows.forEach(row => {
                const title = row.querySelector('td:first-child').textContent.toLowerCase().trim();
                const couponCode = row.querySelector('td:nth-child(2)').textContent.toLowerCase().trim();
                const category = row.querySelector('td:nth-child(3) span').textContent.toLowerCase().trim();
                const typeSpan = row.querySelector('td:nth-child(4) span');
                const type = typeSpan ? typeSpan.textContent.toLowerCase().trim() : '';
                const status = row.querySelector('td:nth-child(8) span').textContent.toLowerCase().trim(); // Updated column index

                let showRow = true;

                // Search filter
                if (searchTerm && !title.includes(searchTerm) && !couponCode.includes(searchTerm)) {
                    showRow = false;
                }

                // Category filter
                if (categoryFilter && category !== categoryFilter) {
                    showRow = false;
                }

                // Type filter
                if (typeFilter) {
                    const normalizedType = type.replace(/[üìã‚è∞üî•‚ö°]/g, '').trim(); // Remove emojis for comparison
                    if (typeFilter === 'expiry-soon' && !normalizedType.includes('expiry soon')) {
                        showRow = false;
                    } else if (typeFilter === 'most-popular' && !normalizedType.includes('most popular')) {
                        showRow = false;
                    } else if (typeFilter === 'almost-gone' && !normalizedType.includes('almost gone')) {
                        showRow = false;
                    }
                }

                // Status filter
                if (statusFilter && status !== statusFilter) {
                    showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
            });
        }


        function toggleDropdown(couponId) {
            const dropdown = document.getElementById(`dropdown-${couponId}`);
            const isHidden = dropdown.classList.contains('hidden');

            // Close all other dropdowns
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                if (d.id !== `dropdown-${couponId}`) {
                    d.classList.add('hidden');
                }
            });

            // Toggle current dropdown
            if (isHidden) {
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.relative')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
            }
        });

        function deleteCoupon(couponId) {
            // Close the dropdown first
            const dropdown = document.getElementById(`dropdown-${couponId}`);
            if (dropdown) {
                dropdown.classList.add('hidden');
            }

            if (confirm('Are you sure you want to delete this coupon?')) {
                fetch(`/method/coupon/${couponId}`, {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Failed to delete coupon');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete coupon');
                    });
            }
        }
    </script>
</body>

</html>