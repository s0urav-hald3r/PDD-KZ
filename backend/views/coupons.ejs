<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temu Coupons Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@heroicons/v1/outline"></script>
</head>

<body class="min-h-screen bg-[#0d1117] text-[#c9d1d9]">
    <div class="container mx-auto px-4 py-8 space-y-8">
        <div class="max-w-7xl mx-auto bg-[#161b22] rounded-2xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Temu Coupons Dashboard</h1>
                <div class="flex space-x-4">
                    <a href="/"
                        class="px-6 py-3 bg-[#30363d] text-[#c9d1d9] rounded-xl hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 hover:bg-[#484f58] focus:outline-none focus:ring-2 focus:ring-[#30363d] focus:ring-offset-2">
                        Back to Dashboard
                    </a>
                    <a href="/screen/coupon/new"
                        class="px-6 py-3 bg-[#238636] text-[#c9d1d9] rounded-xl hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 hover:bg-[#2ea043] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:ring-offset-2">
                        Create New Coupon
                    </a>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div
                    class="bg-[#161b22] rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300 border border-[#30363d]">
                    <h3 class="text-lg font-semibold mb-2 text-[#c9d1d9]">Total Coupons</h3>
                    <p class="text-3xl font-bold text-[#c9d1d9]">
                        <%= totalCoupons %>
                    </p>
                </div>
                <div
                    class="bg-[#161b22] rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300 border border-[#30363d]">
                    <h3 class="text-lg font-semibold mb-2 text-[#c9d1d9]">Active Coupons</h3>
                    <p class="text-3xl font-bold text-[#58a6ff]">
                        <%= activeCoupons %>
                    </p>
                </div>
                <div
                    class="bg-[#161b22] rounded-2xl p-6 transform hover:scale-[1.02] transition-all duration-300 border border-[#30363d]">
                    <h3 class="text-lg font-semibold mb-2 text-[#c9d1d9]">Expired Coupons</h3>
                    <p class="text-3xl font-bold text-[#f85149]">
                        <%= expiredCoupons %>
                    </p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="mb-6 flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search coupons by title or code..."
                        class="w-full px-4 py-3 bg-[#0d1117] border border-[#30363d] rounded-xl text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:border-transparent placeholder-[#8b949e]">
                </div>
                <div class="flex gap-3 relative">
                    <div class="relative">
                        <select id="categoryFilter"
                            class="px-4 py-3 appearance-none bg-[#0d1117] border border-[#30363d] rounded-xl text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:border-transparent hover:border-[#58a6ff] transition-colors duration-200 min-w-[160px]">
                            <option value="">All Categories</option>
                            <option value="electronics">Electronics</option>
                            <option value="fashion">Fashion</option>
                            <option value="home">Home</option>
                            <option value="garden">Garden</option>
                            <option value="beauty">Beauty</option>
                            <option value="health">Health</option>
                            <option value="sports">Sports</option>
                            <option value="toys">Toys</option>
                            <option value="automotive">Automotive</option>
                            <option value="books">Books</option>
                            <option value="food">Food</option>
                            <option value="other">Other</option>
                        </select>
                        <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[#c9d1d9] pointer-events-none"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="relative">
                        <select id="statusFilter"
                            class="px-4 py-3 appearance-none bg-[#0d1117] border border-[#30363d] rounded-xl text-[#c9d1d9] focus:outline-none focus:ring-2 focus:ring-[#238636] focus:border-transparent hover:border-[#58a6ff] transition-colors duration-200 min-w-[140px]">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="expired">Expired</option>
                        </select><svg
                            class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[#c9d1d9] pointer-events-none"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Coupons Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-[#0d1117] border-b border-[#30363d]">
                        <tr>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Title</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Code</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Category</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Discount</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Quantity</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Expiration</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Status</th>
                            <th class="px-6 py-4 text-sm font-semibold text-[#c9d1d9]">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="couponsTableBody">
                        <% if (coupons && coupons.length> 0) { %>
                            <% coupons.forEach(coupon=> { %>
                                <tr class="border-b border-[#30363d] hover:bg-[#1f2937] transition-colors duration-200">
                                    <td class="px-6 py-4">
                                        <div class="font-medium text-[#c9d1d9]">
                                            <%= coupon.title %>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-mono text-sm text-[#58a6ff] bg-[#1f2937] px-2 py-1 rounded">
                                            <%= coupon.couponCode || 'N/A' %>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#1f2937] text-[#c9d1d9]">
                                            <%= coupon.category.charAt(0).toUpperCase() + coupon.category.slice(1) %>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="text-lg font-semibold text-[#f85149]">
                                            -<%= coupon.discount %>%
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center">
                                            <span class="text-[#c9d1d9]">
                                                <%= coupon.usedQuantity %> / <%= coupon.totalQuantity %>
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="text-[#8b949e]">
                                            <% let expirationDate; if (coupon.expirationDate &&
                                                coupon.expirationDate.toDate) { // Handle Firestore timestamp
                                                expirationDate=coupon.expirationDate.toDate(); } else if
                                                (coupon.expirationDate) { // Handle regular date string
                                                expirationDate=new Date(coupon.expirationDate); } else {
                                                expirationDate=new Date(); } if (isNaN(expirationDate.getTime())) { %>
                                                Invalid Date
                                                <% } else { %>
                                                    <%= expirationDate.getDate() %>
                                                        <%= expirationDate.toLocaleDateString('en-US', { month: 'short'
                                                            }) %>
                                                            <%= expirationDate.getFullYear() %>
                                                                <% } %>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <% let isExpired=false; let isActive=false; if (coupon.expirationDate &&
                                            coupon.expirationDate.toDate) { // Handle Firestore timestamp const
                                            expDate=coupon.expirationDate.toDate(); isExpired=expDate <=new Date() ||
                                            coupon.usedQuantity>= coupon.totalQuantity;
                                            isActive = !isExpired;
                                            } else if (coupon.expirationDate) {
                                            // Handle regular date string
                                            const expDate = new Date(coupon.expirationDate);
                                            if (!isNaN(expDate.getTime())) {
                                            isExpired = expDate <= new Date() || coupon.usedQuantity>=
                                                coupon.totalQuantity;
                                                isActive = !isExpired;
                                                } else {
                                                isExpired = true;
                                                isActive = false;
                                                }
                                                } else {
                                                isExpired = true;
                                                isActive = false;
                                                }

                                                if (isActive) { %>
                                                <span
                                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#238636] text-white">
                                                    Active
                                                </span>
                                                <% } else { %>
                                                    <span
                                                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[#f85149] text-white">
                                                        Expired
                                                    </span>
                                                    <% } %>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex space-x-2">
                                            <a href="/screen/coupon/edit/<%= coupon.id %>"
                                                class="text-[#58a6ff] hover:text-[#79b6ff] transition-colors">
                                                Edit
                                            </a>
                                            <button onclick="deleteCoupon('<%= coupon.id %>')"
                                                class="text-[#f85149] hover:text-[#ff6b64] transition-colors">
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="8" class="px-6 py-8 text-center text-[#8b949e]">
                                                <div class="text-lg">No coupons found</div>
                                                <div class="text-sm mt-2">Create your first coupon to get started</div>
                                            </td>
                                        </tr>
                                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            filterCoupons();
        });

        // Filter functionality
        document.getElementById('categoryFilter').addEventListener('change', filterCoupons);
        document.getElementById('statusFilter').addEventListener('change', filterCoupons);

        function filterCoupons() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase().trim();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase().trim();

            const rows = document.querySelectorAll('#couponsTableBody tr');

            rows.forEach(row => {
                const title = row.querySelector('td:first-child').textContent.toLowerCase().trim();
                const couponCode = row.querySelector('td:nth-child(2)').textContent.toLowerCase().trim();
                const category = row.querySelector('td:nth-child(3) span').textContent.toLowerCase().trim();
                const status = row.querySelector('td:nth-child(7) span').textContent.toLowerCase().trim();

                let showRow = true;

                // Search filter
                if (searchTerm && !title.includes(searchTerm) && !couponCode.includes(searchTerm)) {
                    showRow = false;
                }

                // Category filter
                if (categoryFilter && category !== categoryFilter) {
                    showRow = false;
                }

                // Status filter
                if (statusFilter && status !== statusFilter) {
                    showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
            });
        }


        function deleteCoupon(couponId) {
            if (confirm('Are you sure you want to delete this coupon?')) {
                fetch(`/method/coupon/${couponId}`, {
                    method: 'DELETE',
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Failed to delete coupon');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete coupon');
                    });
            }
        }
    </script>
</body>

</html>